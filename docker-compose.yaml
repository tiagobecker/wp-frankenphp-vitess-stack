version: "3.9"

x-args:
  VITESS_TAG: "v23.0.0"   # troque se desejar outra release dispon√≠vel no GHCR

services:
  # -------------------------
  # Topology service (etcd)
  # -------------------------
  etcd:
    image: quay.io/coreos/etcd:v3.5.12
    command:
      - /usr/local/bin/etcd
      - --data-dir=/etcd-data
      - --name=vitess
      - --advertise-client-urls=http://etcd:2379
      - --listen-client-urls=http://0.0.0.0:2379
      - --listen-peer-urls=http://0.0.0.0:2380
    volumes:
      - etcd_data:/etcd-data
    restart: always

  # -------------------------
  # vtctld (control UI)
  # -------------------------
  vtctld:
    image: ghcr.io/vitessio/vitess/vtctld:${VITESS_TAG}
    command: [
      "vtctld",
      "--topo_implementation=etcd2",
      "--topo_global_server_address=etcd:2379",
      "--topo_global_root=/vitess/global",
      "--port=15000",
      "--logtostderr"
    ]
    ports:
      - "15000:15000"
    depends_on:
      - etcd
    restart: always

  # -------------------------
  # mysql server (physical mysqld for tablet 1)
  # -------------------------
  mysql1:
    image: ghcr.io/vitessio/vitess/mysql80:${VITESS_TAG}
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
    volumes:
      - mysql1_data:/var/lib/mysql
    restart: always

  # -------------------------
  # vttablet (binds mysql1 into Vitess)
  # -------------------------
  vttablet1:
    image: ghcr.io/vitessio/vitess/vttablet:${VITESS_TAG}
    command:
      - vttablet
      - --topo_implementation=etcd2
      - --topo_global_server_address=etcd:2379
      - --topo_global_root=/vitess/global
      - --cell=zone1
      - --init_keyspace=wordpress
      - --init_shard=0
      - --init_tablet_type=primary
      - --tablet-path=zone1-0000000100
      - --logtostderr
      - --port=15002
    depends_on:
      - mysql1
      - vtctld
      - etcd
    restart: always

  # -------------------------
  # vtgate (proxy; apps connect aqui)
  # -------------------------
  vtgate:
    image: ghcr.io/vitessio/vitess/vtgate:${VITESS_TAG}
    command:
      - vtgate
      - --topo_implementation=etcd2
      - --topo_global_server_address=etcd:2379
      - --topo_global_root=/vitess/global
      - --cells=zone1
      - --mysql_server_port=15306
      - --port=15991
      - --logtostderr
    ports:
      - "15306:15306"   # MySQL protocol for apps
      - "15991:15991"
    depends_on:
      - vttablet1
    restart: always

  # -------------------------
  # Vitess initializer (runs once at deploy)
  # -------------------------
  vitess-init:
    image: ghcr.io/vitessio/vitess/vtctlclient:${VITESS_TAG}
    depends_on:
      - vtgate
      - vtctld
      - vttablet1
    volumes:
      - ./init_vitess.sh:/app/init_vitess.sh
      - ./vschema.json:/app/vschema.json
    entrypoint: ["/bin/sh", "/app/init_vitess.sh"]
    restart: "no"

  # -------------------------
  # Redis
  # -------------------------
  redis:
    image: redis:7
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data

  # -------------------------
  # FrankenPHP + WordPress
  # -------------------------
  frankenphp:
    build: ./frankenphp
    container_name: frankenphp-wp
    restart: always
    volumes:
      - ./wordpress:/app/public
    environment:
      DB_HOST: vtgate
      DB_PORT: 15306
      DB_NAME: wordpress
      DB_USER: wpuser
      DB_PASSWORD: wppassword
      WP_ENV: production
    depends_on:
      - vtgate
      - redis

volumes:
  etcd_data:
  mysql1_data:
  redis_data:
