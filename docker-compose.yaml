version: "3.9"

services:
  # ================================
  # Vitess Lite (all-in-one)
  # ================================
  vitess:
    image: vitess/lite:17.0.3
    container_name: vitess-lite
    command: [
      "bash", "-c",
      "
      /usr/bin/vtcombo \
        --topo_implementation=etcd2 \
        --topo_global_server_address=localhost:2379 \
        --topo_global_root=/vitess/global \
        --mysql_server_port=15306 \
        --mysql_server_socket_path='' \
        --port=15000 \
        --grpc_port=15999 \
        --logtostderr \
        &
      sleep infinity
      "
    ]
    ports:
      - "15306:15306"   # MySQL Protocol (Vitess)
      - "15000:15000"   # Vitess Admin UI
    volumes:
      - vitess_data:/vt
    restart: always

  # ================================
  # Vitess Initializer
  # ================================
  vitess-init:
    image: mysql:8.0
    depends_on:
      - vitess
    volumes:
      - ./init_vitess.sh:/app/init_vitess.sh
      - ./vschema.json:/app/vschema.json
    entrypoint: ["/bin/sh", "/app/init_vitess.sh"]
    restart: "no"

  # ================================
  # Redis
  # ================================
  redis:
    image: redis:7
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data

  # ================================
  # FrankenPHP + WordPress
  # ================================
  frankenphp:
    build: ./frankenphp
    container_name: frankenphp-wp
    restart: always
    volumes:
      - ./wordpress:/app/public
    environment:
      DB_HOST: vitess
      DB_PORT: 15306
      DB_NAME: wordpress
      DB_USER: wpuser
      DB_PASSWORD: wppassword
      WP_ENV: production
    depends_on:
      - vitess
      - redis

volumes:
  redis_data:
  vitess_data:
